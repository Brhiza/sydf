<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大阿卡纳</title>
    <style>
        /* 背景样式 */
        body {
              font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #87CEFA;
            background: linear-gradient(to bottom right, #9370DB 0, #483D8B 100%);
            overflow: auto;
            position: relative;
            padding-top: 100px
        }

/* 电脑设备（屏幕宽度大于 768px） */
@media (min-width: 769px) {
    body {
        padding-top: 50px; /* 电脑设备留白 */
    }
}

/* 手机设备（屏幕宽度小于等于 768px） */
@media (max-width: 768px) {
    body {
        padding-top: 50px; /* 手机设备留白 */
    }
}



        /* 内容框样式 */
        .content-box {
            width: 90%;
            max-width: 1200px;
            min-width: 300px;
                padding: 20px; /* 减少 padding */
    box-sizing: border-box; /* 确保 padding 不会增加宽度 */
            border-radius: 20px; /* 圆角矩形 */
            background: rgba(255, 255, 255, 0.2); /* 毛玻璃背景 */
            backdrop-filter: blur(10px); /* 毛玻璃效果 */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); /* 阴影 */
            z-index: 2; /* 确保内容框在背景气泡之上 */
            position: relative; /* 相对定位 */
        }

    .card-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0;
      overflow: visible;
    }

    .card-row {
      display: flex;
      justify-content: center;
      gap: -1rem;
      flex-wrap: wrap;
    }

    .card {
      width: 6rem;
      height: 9rem;
      border: 1px solid #ccc;
      margin: 0.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      position: relative;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: opacity 0.5s ease-in-out, transform 0.3s ease-in-out;
    }

    @media (max-width: 768px) {
      .card {
        width: 2.5rem;
        height: 4rem;
      }

      .card-row {
        gap: 0rem;
      }

      .input-container input {
        width: 90%;
        max-width: 100%;
      }
    }

    @media (min-width: 769px) {
      .card {
        width: 6rem;
        height: 9rem;
      }
    }

    .card.hidden {
      opacity: 0;
    }

        .result-container {
            width: 90%;
            max-width: 1200px;
            overflow: auto; /* 超出部分滚动 */
            box-sizing: border-box; /* 包含 padding 和 border */
            display: flex;
            flex-wrap: wrap; /* 允许换行 */
            gap: 10px; /* 子元素间距 */
            align-items: center;
            justify-content: center;
            margin-top: 2rem;
        }
        .result-container img {
            max-width: 100%; /* 图片宽度不超过容器 */
            height: auto; /* 高度自适应 */
        }
        .result-container p {
            word-wrap: break-word; /* 允许长单词换行 */
            margin: 0;
        }

    .reset-button,
    .copy-button,
    .ai-button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin: 5px;
    }

    .reset-button:hover,
    .copy-button:hover,
    .ai-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .reset-button:active,
    .copy-button:active,
    .ai-button:active {
        background: rgba(138, 43, 226, 0.6);
        border-color: rgba(138, 43, 226, 0.8);
        box-shadow: 0 0 15px rgba(138, 43, 226, 0.3);
    }

    @media (max-width: 768px) {
        .content-box {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        
        .reset-button,
        .copy-button,
        .ai-button {
            padding: 8px 16px;
            font-size: 0.9rem;
            margin: 3px;
        }
    }

    .centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }


h1 {
  font-size: 48px; /* 默认字体大小 */
  color: #fff;
  margin-bottom: 30px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  flex-direction: column;
  align-items: center;
  text-align: center;
}

/* 针对手机设备的样式 */
@media (max-width: 768px) {
  h1 {
    font-size: 32px; /* 手机端字体大小 */
  }
}
        
    .input-container {
            font-size: 24px;
            color: #fff;
            margin-bottom: 30px;
                  flex-direction: column;
      align-items: center;
      text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .input-container input {
      width: 90%;
      max-width: 100%;
      padding: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
            background: rgba(255, 255, 255, 0.2); /* 毛玻璃背景 */
            backdrop-filter: blur(10px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      margin-top: 0.5rem;
    }

    .input-container input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }

    .output-text {
      margin-bottom: 20px;
      width: 100%;
      font-size: 1.2rem;
      color: #F5F5F5;
      padding: 1rem;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .output-text strong {
      font-size: 1.4rem;
      font-weight: bold;
      color: #F5F5F5;
    }

    .output-text em {
      font-size: 1.1rem;
      font-style: italic;
      color: #F5F5F5;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 20px;
      width: 100%;
    }

    .loading-animation {
      display: none;
      margin-top: 2rem;
      font-size: 1.2rem;
      font-weight: bold;
      color: #FFF;
      text-align: center;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .loading-animation::after {
      content: 'AI疯狂思考中...';
      animation: loading 1s infinite;
    }

    @keyframes loading {
      0% {
        content: 'AI疯狂思考中.';
      }

      33% {
        content: 'AI疯狂思考中..';
      }

      66% {
        content: 'AI疯狂思考中...';
      }

      100% {
        content: 'AI疯狂思考中.';
      }
    }

    #outputText .highlight {
      background-color: #fff3cd;
      padding: 2px 4px;
      border-radius: 4px;
    }

    #outputText blockquote {
      border-left: 4px solid #6c757d;
      padding-left: 1em;
      margin-left: 0;
      color: #6c757d;
    }

    .select-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin: 1rem 0;
    }

    .select-group {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        align-items: center;
    }

    .card-select, 
    .position-select {
        padding: 0.8rem 1rem;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        font-size: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
        outline: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .card-select {
        width: 200px;
    }

    .position-select {
        width: 100px;
    }

    /* 下拉菜单选项样式 */
    .card-select option,
    .position-select option {
        background: rgba(255, 255, 255, 0.1);
        color: #333;
        padding: 10px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    /* 添加自定义下拉箭头 */
    .card-select,
    .position-select {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 1em auto;
        padding-right: 2.5em;
    }

    /* 移除Firefox的默认箭头 */
    .card-select:-moz-focusring,
    .position-select:-moz-focusring {
        color: transparent;
        text-shadow: 0 0 0 #fff;
    }

    /* 悬停和聚焦状态 */
    .card-select:hover,
    .position-select:hover,
    .card-select:focus,
    .position-select:focus {
        background-color: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.4);
    }

    /* 移动端适配 */
    @media (max-width: 768px) {
        .select-group {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .card-select,
        .position-select {
            width: 90%;
            max-width: 300px;
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
        }
    }

    .confirm-button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin: 20px auto;
        display: inline-block;
    }

    .confirm-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .confirm-button:active {
        background: rgba(138, 43, 226, 0.6);
        border-color: rgba(138, 43, 226, 0.8);
        box-shadow: 0 0 15px rgba(138, 43, 226, 0.3);
    }

    .input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .button-container {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 20px;
        width: 100%;
    }

    .copy-button,
    .reset-button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .copy-button:hover,
    .reset-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    </style>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- 背景气泡动画 -->


    <!-- 内容框 -->
    <h1>时月的大阿卡纳</h1>
    <div class="content-box">
    <div class="input-container">

      1.写下您的问题
      <br><br>
      <input type="text" id="inputText" placeholder="只能提问能用Yes/No回答的问题哦" autofocus>
      <br><br>
      2.选择三张塔罗牌
      <br><br>
      <div class="select-container">
          <!-- 第一张牌选择 -->
          <div class="select-group">
              <select id="card1" class="card-select">
                  <option value="">选择第一张牌</option>
                  <option value="0">愚人</option>
                  <option value="1">魔术师</option>
                  <option value="2">女祭司</option>
                  <option value="3">皇后</option>
                  <option value="4">皇帝</option>
                  <option value="5">教皇</option>
                  <option value="6">恋人</option>
                  <option value="7">战车</option>
                  <option value="8">力量</option>
                  <option value="9">隐士</option>
                  <option value="10">命运之轮</option>
                  <option value="11">正义</option>
                  <option value="12">倒吊人</option>
                  <option value="13">死亡</option>
                  <option value="14">节制</option>
                  <option value="15">恶魔</option>
                  <option value="16">高塔</option>
                  <option value="17">星星</option>
                  <option value="18">月亮</option>
                  <option value="19">太阳</option>
                  <option value="20">审判</option>
                  <option value="21">世界</option>
              </select>
              <select id="position1" class="position-select">
                  <option value="upright">正位</option>
                  <option value="reversed">逆位</option>
              </select>
          </div>
          <!-- 第二张牌选择 -->
          <div class="select-group">
              <select id="card2" class="card-select">
                  <option value="">选择第二张牌</option>
                  <option value="0">愚人</option>
                  <option value="1">魔术师</option>
                  <option value="2">女祭司</option>
                  <option value="3">皇后</option>
                  <option value="4">皇帝</option>
                  <option value="5">教皇</option>
                  <option value="6">恋人</option>
                  <option value="7">战车</option>
                  <option value="8">力量</option>
                  <option value="9">隐士</option>
                  <option value="10">命运之轮</option>
                  <option value="11">正义</option>
                  <option value="12">倒吊人</option>
                  <option value="13">死亡</option>
                  <option value="14">节制</option>
                  <option value="15">恶魔</option>
                  <option value="16">高塔</option>
                  <option value="17">星星</option>
                  <option value="18">月亮</option>
                  <option value="19">太阳</option>
                  <option value="20">审判</option>
                  <option value="21">世界</option>
              </select>
              <select id="position2" class="position-select">
                  <option value="upright">正位</option>
                  <option value="reversed">逆位</option>
              </select>
          </div>
          <!-- 第三张牌选择 -->
          <div class="select-group">
              <select id="card3" class="card-select">
                  <option value="">选择第三张牌</option>
                  <option value="0">愚人</option>
                  <option value="1">魔术师</option>
                  <option value="2">女祭司</option>
                  <option value="3">皇后</option>
                  <option value="4">皇帝</option>
                  <option value="5">教皇</option>
                  <option value="6">恋人</option>
                  <option value="7">战车</option>
                  <option value="8">力量</option>
                  <option value="9">隐士</option>
                  <option value="10">命运之轮</option>
                  <option value="11">正义</option>
                  <option value="12">倒吊人</option>
                  <option value="13">死亡</option>
                  <option value="14">节制</option>
                  <option value="15">恶魔</option>
                  <option value="16">高塔</option>
                  <option value="17">星星</option>
                  <option value="18">月亮</option>
                  <option value="19">太阳</option>
                  <option value="20">审判</option>
                  <option value="21">世界</option>
              </select>
              <select id="position3" class="position-select">
                  <option value="upright">正位</option>
                  <option value="reversed">逆位</option>
              </select>
          </div>
      </div>
      <button id="confirmButton" class="confirm-button">确认选择</button>
    </div>
  </header>
  <main class="centered">
    <div class="output-text" id="outputText"></div>
    <div class="loading-animation" id="loadingAnimation" style="display: none;"></div>
    <div class="button-container" style="display: none;">
        <button class="copy-button" onclick="copyResult()">复制结果</button>
        <button class="reset-button" onclick="resetCards()">重新选择</button>
    </div>
  </main>
    </div>

    <script>
        // 首先定义所有需要的变量
        const majorArcanaCardNames = ["愚人", "魔术师", "女祭司", "皇后", "皇帝", "教皇", "恋人", "战车", "力量", "隐士", "命运之轮", "正义", "倒吊人", "死亡", "节制", "恶魔", "高塔", "星星", "月亮", "太阳", "审判", "世界"];
        let drawnCards = [];

        // 缓存常用的DOM元素引用
        const elements = {
            inputText: document.getElementById('inputText'),
            outputText: document.getElementById('outputText'),
            loadingAnimation: document.getElementById('loadingAnimation'),
            buttonContainer: document.querySelector('.button-container'),
            confirmButton: document.getElementById('confirmButton'),
            cardSelects: Array.from({length: 3}, (_, i) => document.getElementById(`card${i + 1}`)),
            positionSelects: Array.from({length: 3}, (_, i) => document.getElementById(`position${i + 1}`))
        };

        // API调用函数
        async function callAIInterpretation(prompt) {
            const response = await fetch('https://api.ikun.jp/api/ai-interpretation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    messages: [{
                        content: "你是一个专业的塔罗师，你会根据我的问题和抽的牌给我解决问题。我知道塔罗牌的解读并不是绝对的，但我希望你根据牌意给我一个准确的答案，并在解析完后用出一句总结",
                        role: "system"
                    },
                    {
                        content: prompt,
                        role: "user"
                    }],
                    model: "deepseek-chat",
                    max_tokens: 2048,
                    temperature: 1,
                    top_p: 1
                })
            });

            if (!response.ok) {
                throw new Error(await response.text() || '服务器响应错误');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // 添加加载状态管理
        const loadingState = {
            start() {
                elements.confirmButton.disabled = true;
                elements.loadingAnimation.style.display = 'block';
                elements.outputText.style.display = 'none';
                elements.buttonContainer.style.display = 'none';
            },
            end() {
                elements.confirmButton.disabled = false;
                elements.loadingAnimation.style.display = 'none';
                elements.outputText.style.display = 'block';
                elements.buttonContainer.style.display = 'flex';
            }
        };

        // 添加防抖处理，避免频繁点击
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const context = this; // 保存this上下文
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(context, args); // 使用保存的this上下文
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 将点击处理函数单独定义
        const handleConfirmClick = async function() {
            const button = this;
            button.style.display = 'none';
            
            if (!elements.inputText.value.trim()) {
                alert("请先写下您的问题");
                button.style.display = 'inline-block';
                return;
            }

            // 检查卡片选择
            if (elements.cardSelects.some(select => !select.value)) {
                const index = elements.cardSelects.findIndex(select => !select.value) + 1;
                alert(`请选择第${index}张牌`);
                button.style.display = 'inline-block';
                return;
            }

            loadingState.start();

            try {
                const cardNames = elements.cardSelects.map((select, i) => 
                    `${elements.positionSelects[i].value === 'reversed' ? "逆位" : ""}${majorArcanaCardNames[select.value]}`
                ).join('、');
                
                const aiResponse = await callAIInterpretation(`${cardNames}，${elements.inputText.value}`);

                // 去除markdown格式
                const cleanResponse = aiResponse
                    .replace(/\*\*/g, '') // 去除粗体
                    .replace(/\*/g, '')   // 去除斜体
                    .replace(/`/g, '')    // 去除代码块
                    .replace(/#{1,6}\s/g, '') // 去除标题
                    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // 将链接转换为纯文本
                    .replace(/\n+/g, '\n') // 将多个换行符替换为单个换行符
                    .trim();              // 去除首尾空白

                elements.outputText.textContent = cleanResponse;
                loadingState.end();

            } catch (error) {
                console.error("AI解读失败:", error);
                alert("AI解读失败: " + error.message);
                button.style.display = 'inline-block';
                elements.loadingAnimation.style.display = 'none';
                elements.outputText.style.display = 'block';
            }
        };

        // 使用防抖优化点击事件
        elements.confirmButton.addEventListener('click', debounce(handleConfirmClick, 500));

        // 复制结果函数
        function copyResult() {
            navigator.clipboard.writeText(elements.outputText.textContent)
                .then(() => alert("复制成功"))
                .catch(err => alert("复制失败: " + err));
        }

        // 重置函数
        function resetCards() {
            elements.cardSelects.forEach(select => select.value = '');
            elements.positionSelects.forEach(select => select.value = 'upright');
            elements.inputText.value = '';
            elements.outputText.textContent = '';
            elements.confirmButton.style.display = 'inline-block';
            elements.buttonContainer.style.display = 'none';
        }
    </script>
</body>
</html>